<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‘ãƒƒã¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼</title>
    <!-- Content Security Policy (CSP) for Google Generative Language API -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.tailwindcss.com https://unpkg.com https://www.gstatic.com 'unsafe-inline'; style-src 'self' https://fonts.googleapis.com 'unsafe-inline'; img-src 'self' blob: data:; connect-src 'self' https://generativelanguage.googleapis.com; font-src 'self' https://fonts.gstatic.com;">
    <!-- Tailwind CSS CDNã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel Standaloneã‚’èª­ã¿è¾¼ã¿ (JSXã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§å¤‰æ›ã™ã‚‹ãŸã‚) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Reactã¨ReactDOMã®UMDãƒ“ãƒ«ãƒ‰ã‚’èª­ã¿è¾¼ã¿ (BabelãŒã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦åˆ©ç”¨ã™ã‚‹ãŸã‚) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã€Hachi Maru Popãƒ•ã‚©ãƒ³ãƒˆã€Kiwi Maruãƒ•ã‚©ãƒ³ãƒˆã€Puikkoãƒ•ã‚©ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚€ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Hachi+Maru+Pop&family=Kiwi+Maru:wght@400;700&family=Puikko&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆTailwind CSSã®JITãƒ¢ãƒ¼ãƒ‰ã‚„ã‚«ã‚¹ã‚¿ãƒ è¨­å®šãŒãªã„å ´åˆã®ãŸã‚ã«ç›´æ¥å®šç¾©ï¼‰ */
        @keyframes bounce-in {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        .animate-bounce-in {
            animation: bounce-in 0.5s ease-out forwards;
        }

        /* æ–‡å­—ãŒã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ  */
        @keyframes jump {
            0% { transform: translateY(0); }
            20% { transform: translateY(-10px); } /* ä¸Šã«ã‚¸ãƒ£ãƒ³ãƒ— */
            40% { transform: translateY(0); }
            60% { transform: translateY(-5px); } /* å°‘ã—è·³ã­è¿”ã‚‹ */
            80% { transform: translateY(0); }
            100% { transform: translateY(0); }
        }

        /* ãƒ›ãƒãƒ¼æ™‚ã«å„æ–‡å­—ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ */
        .app-title:hover .char {
            display: inline-block; /* transformã‚’é©ç”¨ã™ã‚‹ãŸã‚ã«å¿…è¦ */
            animation: jump 0.8s ease-out forwards; /* 0.8ç§’ã§1å›å†ç”Ÿã—ã€æœ€çµ‚çŠ¶æ…‹ã‚’ä¿æŒ */
        }

        /* å„æ–‡å­—ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é…å»¶ã‚’è¨­å®šã—ã¦ã‚¹ã‚¿ãƒƒã‚¬ãƒ¼ãƒ‰åŠ¹æœã‚’ä½œæˆ */
        /* çµµæ–‡å­—ãŒæœ€åˆã®å­è¦ç´ ãªã®ã§ã€æ–‡å­—ã¯nth-child(2)ã‹ã‚‰å§‹ã¾ã‚‹ */
        .app-title:hover .char:nth-child(2) { animation-delay: 0s; } /* ãƒ‘ */
        .app-title:hover .char:nth-child(3) { animation-delay: 0.05s; } /* ãƒƒ */
        .app-title:hover .char:nth-child(4) { animation-delay: 0.1s; } /* ã¨ */
        .app-title:hover .char:nth-child(5) { animation-delay: 0.15s; } /* ãƒ¡ */
        .app-title:hover .char:nth-child(6) { animation-delay: 0.2s; } /* ãƒ‹ */
        .app-title:hover .char:nth-child(7) { animation-delay: 0.25s; } /* ãƒ¥ */
        .app-title:hover .char:nth-child(8) { animation-delay: 0.3s; } /* ãƒ¼ */

        /* ã‚¢ãƒ—ãƒªã‚¿ã‚¤ãƒˆãƒ«å…¨ä½“ã®ãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨ */
        .app-title {
            font-family: 'Hachi Maru Pop', cursive;
        }

        /* ã€Œãƒ‘ãƒƒã€ã®éƒ¨åˆ†ã«å¯æ„›ã‚‰ã—ã„å¤ªå­—ãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨ */
        .cute-bold-char {
            font-family: 'Puikko', cursive; /* ãƒ•ã‚©ãƒ³ãƒˆã‚’Puikkoã«å¤‰æ›´ */
            font-weight: 700; /* å¤ªå­— */
            /* font-size ã¯å€‹åˆ¥ã®spanè¦ç´ ã«ç›´æ¥æŒ‡å®šã™ã‚‹ãŸã‚å‰Šé™¤ */
            /* letter-spacing ã¯å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ */
        }

        /* é£Ÿå“é¢¨ã®èƒŒæ™¯ãƒ‘ã‚¿ãƒ¼ãƒ³ */
        .table-background {
            background-color: #fdfaf6; /* ãƒ™ãƒ¼ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ è‰² */
            background-image: repeating-linear-gradient(45deg, #fcefe8 0%, #fcefe8 15px, #fdfaf6 15px, #fdfaf6 30px);
            background-size: 30px 30px; /* ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚µã‚¤ã‚ºã‚’å°‘ã—å¤§ããã—ã¦ç›®ç«‹ãŸã›ã‚‹ */
        }
    </style>
</head>
<body>
    <noscript>JavaScriptã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯JavaScriptãŒå¿…è¦ã§ã™ã€‚</noscript>
    <!-- Reactã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹ãƒ«ãƒ¼ãƒˆè¦ç´  -->
    <div id="root"></div>

    <!-- Reactã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®JavaScriptã‚³ãƒ¼ãƒ‰ã‚’åŸ‹ã‚è¾¼ã¿ -->
    <script type="text/babel">
        // Reactã¨ReactDOMã¯ã™ã§ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«åˆ©ç”¨å¯èƒ½
        const { useState, useRef, useEffect } = React; // Reactã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ãƒ•ãƒƒã‚¯ã‚’ç›´æ¥å–å¾—

        // ãƒ¡ã‚¤ãƒ³ã®Appã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        const App = () => {
          // é¸æŠã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®çŠ¶æ…‹
          const [selectedImage, setSelectedImage] = useState(null);
          // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã®çŠ¶æ…‹
          const [imagePreviewUrl, setImagePreviewUrl] = useState('');
          // è§£æã•ã‚ŒãŸé£Ÿæã®ãƒªã‚¹ãƒˆã®çŠ¶æ…‹ (å„é£Ÿæã«é¸æŠçŠ¶æ…‹ã‚’è¿½åŠ )
          const [ingredients, setIngredients] = useState([]); // ä¾‹: [{ name: 'ã‚Šã‚“ã”', selected: true }]
          // ç”Ÿæˆã•ã‚ŒãŸãƒ¬ã‚·ãƒ”ã®çŠ¶æ…‹
          const [recipes, setRecipes] = useState('');
          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ï¼ˆAPIå‘¼ã³å‡ºã—ä¸­ã‹ã©ã†ã‹ï¼‰
          const [loading, setLoading] = useState(false);
          // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®çŠ¶æ…‹
          const [error, setError] = useState('');
          // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã‹ã©ã†ã‹ã®çŠ¶æ…‹
          const [isDragging, setIsDragging] = useState(false);
          // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®çŠ¶æ…‹
          const [chatHistory, setChatHistory] = useState([]);
          // ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®çŠ¶æ…‹
          const [currentChatMessage, setCurrentChatMessage] = useState('');
          // ãƒãƒ£ãƒƒãƒˆãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‹ã©ã†ã‹ï¼ˆãƒ¬ã‚·ãƒ”ææ¡ˆå¾Œã®ã¿è¡¨ç¤ºï¼‰
          const [isChatActive, setIsChatActive] = useState(false);

          // è§£æçµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®å‚ç…§
          const ingredientsSectionRef = useRef(null);
          // ææ¡ˆã•ã‚ŒãŸçŒ®ç«‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®å‚ç…§
          const recipesSectionRef = useRef(null);
          // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨å‚ç…§
          const chatHistoryRef = useRef(null);

          // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸã¨ãã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
          const handleImageChange = (file) => { // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥å—ã‘å–ã‚‹ã‚ˆã†ã«å¤‰æ›´
            if (file) {
              setSelectedImage(file);
              setImagePreviewUrl(URL.createObjectURL(file));
              setIngredients([]);
              setRecipes('');
              setError('');
              setChatHistory([]); // æ–°ã—ã„ç”»åƒãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚‰ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢
              setIsChatActive(false); // ãƒãƒ£ãƒƒãƒˆã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            } else {
              setSelectedImage(null);
              setImagePreviewUrl('');
            }
          };

          // ç”»åƒã‚’Base64ã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
          const toBase64 = (file) => {
            return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.readAsDataURL(file);
              reader.onload = () => resolve(reader.result.split(',')[1]);
              reader.onerror = (error) => reject(error);
            });
          };

          // ç”»åƒã‚’è§£æã—ã€é£Ÿæã‚’ç‰¹å®šã™ã‚‹é–¢æ•°
          const analyzeImage = async () => {
            if (!selectedImage) {
              setError('ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
              return;
            }

            setLoading(true);
            setError('');
            setIngredients([]);
            setRecipes(''); // è§£æå‰ã«ãƒ¬ã‚·ãƒ”ã‚‚ã‚¯ãƒªã‚¢
            setChatHistory([]); // è§£æå‰ã«ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚‚ã‚¯ãƒªã‚¢
            setIsChatActive(false); // ãƒãƒ£ãƒƒãƒˆã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹

            try {
              const base64ImageData = await toBase64(selectedImage);

              const apiChatHistory = [];
              apiChatHistory.push({
                role: 'user',
                parts: [
                  { text: 'ã“ã®å†·è”µåº«ã®ç”»åƒã‹ã‚‰é£Ÿæã‚’ç‰¹å®šã—ã¦ãã ã•ã„ã€‚ãƒªã‚¹ãƒˆå½¢å¼ã§ç®‡æ¡æ›¸ãã«ã—ã¦ãã ã•ã„ã€‚å„é …ç›®ã¯ãƒã‚¤ãƒ•ãƒ³ã§å§‹ã‚ã¦ãã ã•ã„ã€‚ä¾‹ï¼š- ã‚Šã‚“ã”\n- åµ\n- ç‰›ä¹³' },
                  {
                    inlineData: {
                      mimeType: selectedImage.type,
                      data: base64ImageData,
                    },
                  },
                ],
              });

              const payload = { contents: apiChatHistory };
              // ã“ã“ã«ã‚ãªãŸã®Google Cloud APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
              // ä¾‹: const apiKey = 'YOUR_API_KEY_HERE';
              // æ³¨æ„: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã«APIã‚­ãƒ¼ã‚’ç›´æ¥åŸ‹ã‚è¾¼ã‚€ã®ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚
              // æœ¬ç•ªç’°å¢ƒã§ã¯ã€APIã‚­ãƒ¼ã‚’ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ç®¡ç†ã™ã‚‹ãªã©ã®å¯¾ç­–ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚
              const apiKey = ''; 
              const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
              });

              const result = await response.json();

              if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                let text = result.candidates[0].content.parts[0].text;

                const unwantedPrefixes = [
                  'ã“ã®å†·è”µåº«ã®ç”»åƒã‹ã‚‰ç‰¹å®šã§ãã‚‹é£Ÿæã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚',
                  'å†·è”µåº«ã®ç”»åƒã‹ã‚‰ç‰¹å®šã§ãã‚‹é£Ÿæã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚',
                  'ç‰¹å®šã•ã‚ŒãŸé£Ÿæã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚',
                  'ä»¥ä¸‹ã«å†·è”µåº«ã®ç”»åƒã‹ã‚‰ç‰¹å®šã•ã‚ŒãŸé£Ÿæã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚',
                  'å†·è”µåº«ã®ç”»åƒã«åŸºã¥ãã€ç‰¹å®šã•ã‚ŒãŸé£Ÿæã®ãƒªã‚¹ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚',
                  'å†·è”µåº«ã«ã‚ã‚‹é£Ÿæã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚',
                  'ä»¥ä¸‹ã¯ç”»åƒã‹ã‚‰ç‰¹å®šã•ã‚ŒãŸé£Ÿæã§ã™ã€‚',
                  'ç”»åƒã‹ã‚‰æ¤œå‡ºã•ã‚ŒãŸé£Ÿæï¼š'
                ];

                for (const prefix of unwantedPrefixes) {
                  if (text.startsWith(prefix)) {
                    text = text.substring(prefix.length).trim();
                    break;
                  }
                }

                const parsedIngredients = text.split('\n')
                  .map(item => item.trim())
                  .filter(item => item.startsWith('- ') && item.length > 2)
                  .map(name => ({ name: name.replace(/^- /, '').trim(), selected: true }));
                setIngredients(parsedIngredients);
              } else {
                setError('é£Ÿæã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                console.error('API Response Error:', result);
              }
            } catch (err) {
              setError('ç”»åƒã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message);
              console.error('Image analysis error:', err);
            } finally {
              setLoading(false);
            }
          };

          // é£Ÿæã®é¸æŠçŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
          const handleIngredientToggle = (index) => {
            setIngredients(prevIngredients =>
              prevIngredients.map((item, i) =>
                i === index ? { ...item, selected: !item.selected } : item
              )
            );
          };

          // é£Ÿæã«åŸºã¥ã„ã¦çŒ®ç«‹ã‚’ææ¡ˆã™ã‚‹é–¢æ•°
          const generateRecipes = async () => {
            const selectedIngredients = ingredients
              .filter(item => item.selected)
              .map(item => item.name);

            if (selectedIngredients.length === 0) {
              setError('çŒ®ç«‹ã‚’ææ¡ˆã™ã‚‹ã«ã¯ã€å°‘ãªãã¨ã‚‚1ã¤ã®é£Ÿæã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
              return;
            }

            setLoading(true);
            setError('');
            setRecipes('');
            setChatHistory([]); // æ–°ã—ã„ãƒ¬ã‚·ãƒ”ææ¡ˆã®å‰ã«ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢
            setIsChatActive(false); // ãƒ¬ã‚·ãƒ”ç”Ÿæˆä¸­ã¯ãƒãƒ£ãƒƒãƒˆã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹

            try {
              const ingredientsList = selectedIngredients.join(', ');
              const prompt = `ä»¥ä¸‹ã®é£Ÿæã‚’ä½¿ã£ã¦ã€å®Ÿç”¨çš„ãªçŒ®ç«‹ã‚’ã„ãã¤ã‹ææ¡ˆã—ã¦ãã ã•ã„ã€‚å„çŒ®ç«‹ã«ã¯ã€æ–™ç†åã€ç°¡å˜ãªèª¬æ˜ã€ä¸»è¦ãªææ–™ã‚’å«ã‚ã¦ãã ã•ã„ã€‚ç®‡æ¡æ›¸ãã§ãŠé¡˜ã„ã—ã¾ã™ã€‚
              é£Ÿæ: ${ingredientsList}`;

              const apiChatHistory = [];
              apiChatHistory.push({ role: 'user', parts: [{ text: prompt }] });

              const payload = { contents: apiChatHistory };
              // ã“ã“ã«ã‚ãªãŸã®Google Cloud APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
              // ä¾‹: const apiKey = 'YOUR_API_KEY_HERE';
              // æ³¨æ„: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã«APIã‚­ãƒ¼ã‚’ç›´æ¥åŸ‹ã‚è¾¼ã‚€ã®ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚
              // æœ¬ç•ªç’°å¢ƒã§ã¯ã€APIã‚­ãƒ¼ã‚’ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ç®¡ç†ã™ã‚‹ãªã©ã®å¯¾ç­–ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚
              const apiKey = ''; 
              const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
              });

              const result = await response.json();

              if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                setRecipes(text);
                // ãƒ¬ã‚·ãƒ”ç”Ÿæˆå¾Œã€ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«æœ€åˆã®AIå¿œç­”ã‚’è¿½åŠ ã—ã€ãƒãƒ£ãƒƒãƒˆã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
                setChatHistory([{ role: 'model', text: text }]);
                setIsChatActive(true);
              } else {
                setError('çŒ®ç«‹ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                console.error('API Response Error:', result);
              }
            } catch (err) {
              setError('çŒ®ç«‹ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message);
              console.error('Recipe generation error:', err);
            } finally {
              setLoading(false);
            }
          };

          // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
          const sendChatMessage = async () => {
            if (!currentChatMessage.trim()) return; // ç©ºã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯é€ä¿¡ã—ãªã„

            const userMessage = currentChatMessage;
            setCurrentChatMessage(''); // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«è¿½åŠ 
            setChatHistory(prev => [...prev, { role: 'user', text: userMessage }]);
            setLoading(true);
            setError('');

            try {
              // APIã«é€ä¿¡ã™ã‚‹ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’æ§‹ç¯‰
              // æœ€åˆã®ãƒ¬ã‚·ãƒ”ææ¡ˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨å¿œç­”ã‚’å«ã‚ã‚‹ã“ã¨ã§ã€ä¼šè©±ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç¶­æŒ
              const apiChatHistory = [
                { role: 'user', parts: [{ text: `ä»¥ä¸‹ã®é£Ÿæã‚’ä½¿ã£ã¦ã€å®Ÿç”¨çš„ãªçŒ®ç«‹ã‚’ã„ãã¤ã‹ææ¡ˆã—ã¦ãã ã•ã„ã€‚å„çŒ®ç«‹ã«ã¯ã€æ–™ç†åã€ç°¡å˜ãªèª¬æ˜ã€ä¸»è¦ãªææ–™ã‚’å«ã‚ã¦ãã ã•ã„ã€‚ç®‡æ¡æ›¸ãã§ãŠé¡˜ã„ã—ã¾ã™ã€‚\né£Ÿæ: ${ingredients.filter(item => item.selected).map(item => item.name).join(', ')}` }] },
                { role: 'model', parts: [{ text: recipes }] }, // æœ€åˆã®ãƒ¬ã‚·ãƒ”ææ¡ˆ
                { role: 'user', parts: [{ text: userMessage }] } // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
              ];

              const payload = { contents: apiChatHistory };
              // ã“ã“ã«ã‚ãªãŸã®Google Cloud APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
              // ä¾‹: const apiKey = 'YOUR_API_KEY_HERE';
              // æ³¨æ„: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã«APIã‚­ãƒ¼ã‚’ç›´æ¥åŸ‹ã‚è¾¼ã‚€ã®ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚
              // æœ¬ç•ªç’°å¢ƒã§ã¯ã€APIã‚­ãƒ¼ã‚’ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ç®¡ç†ã™ã‚‹ãªã©ã®å¯¾ç­–ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚
              const apiKey = ''; 
              const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
              });

              const result = await response.json();

              if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                const aiResponse = result.candidates[0].content.parts[0].text;
                setChatHistory(prev => [...prev, { role: 'model', text: aiResponse }]);
              } else {
                setError('AIã‹ã‚‰ã®å¿œç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                console.error('API Response Error:', result);
              }
            } catch (err) {
              setError('ãƒãƒ£ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message);
              console.error('Chat error:', err);
            } finally {
              setLoading(false);
            }
          };

          // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
          const handleDragOver = (event) => {
            event.preventDefault();
            setIsDragging(true);
          };

          // ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
          const handleDragLeave = () => {
            setIsDragging(false);
          };

          // ãƒ‰ãƒ­ãƒƒãƒ—æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
          const handleDrop = (event) => {
            event.preventDefault();
            setIsDragging(false);

            const files = event.dataTransfer.files;
            if (files && files.length > 0) {
              const file = files[0];
              if (file.type.startsWith('image/')) {
                handleImageChange(file);
              } else {
                setError('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚');
              }
            }
          };

          // ingredientsãŒæ›´æ–°ã•ã‚Œã€ã‹ã¤ç©ºã§ãªã„å ´åˆã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
          useEffect(() => {
            if (ingredients.length > 0 && ingredientsSectionRef.current) {
              ingredientsSectionRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }, [ingredients]);

          // recipesãŒæ›´æ–°ã•ã‚Œã€ã‹ã¤ç©ºã§ãªã„å ´åˆã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
          useEffect(() => {
            if (recipes && recipesSectionRef.current) {
              recipesSectionRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }, [recipes]);

          // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒæ›´æ–°ã•ã‚ŒãŸã¨ãã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
          useEffect(() => {
            if (chatHistoryRef.current) {
              chatHistoryRef.current.scrollTop = chatHistoryRef.current.scrollHeight;
            }
          }, [chatHistory]);

          return (
            <> {/* React Fragment ã‚’è¿½åŠ  */}
              <div className="min-h-screen p-4 font-sans flex flex-col items-center justify-center py-12 table-background">
                <h1 className="app-title text-5xl font-extrabold text-gray-800 mb-10 text-center drop-shadow-lg tracking-tight">
                  {/* çµµæ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³ã®è¿½åŠ  */}
                  <span style={{ display: 'inline-block', marginRight: '10px', verticalAlign: 'middle', fontSize: '1.2em' }}>
                      ğŸ´
                  </span>
                  {/* ã‚¢ãƒ—ãƒªåã®å¤‰æ›´ã¨æ–‡å­—ã”ã¨ã®span */}
                  <span className="char text-orange-500 cute-bold-char" style={{ marginRight: '-16px', fontSize: '80px' }}>ãƒ‘</span> {/* ãƒ‘ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’80pxã« */}
                  <span className="char text-orange-500 cute-bold-char" style={{ marginRight: '-14px' }}>ãƒƒ</span> {/* ã“ã“ã‚’-14pxã«å¤‰æ›´ */}
                  <span className="char" style={{ fontSize: '40px', marginRight: '-10px' }}>ã¨</span> {/* ã¨ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’40pxã«ã€ãƒãƒ¼ã‚¸ãƒ³ã‚’-10pxã« */}
                  <span className="char">ãƒ¡</span>
                  <span className="char">ãƒ‹</span>
                  <span className="char">ãƒ¥</span>
                  <span className="char">ãƒ¼</span>
                </h1>

                <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full mb-10 transform transition-all duration-300 hover:scale-[1.01] hover:shadow-3xl border border-gray-100">
                  <h2 className="text-3xl font-bold text-gray-700 mb-6 border-b-2 border-blue-200 pb-4 text-center">
                    1. å†·è”µåº«ã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                  </h2>
                  {/* ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ */}
                  <div
                    onDragOver={handleDragOver}
                    onDragLeave={handleDragLeave}
                    onDrop={handleDrop}
                    className={`border-4 border-dashed rounded-2xl p-10 text-center cursor-pointer mb-8
                      ${isDragging ? 'border-blue-500 bg-blue-50 ring-4 ring-blue-200' : 'border-gray-300 bg-gray-50'}
                      hover:border-blue-400 hover:bg-blue-50 transition duration-300 ease-in-out transform hover:scale-[1.005]`}
                  >
                    <p className="text-xl text-gray-700 font-medium mb-3">ç”»åƒã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
                    <p className="text-lg text-gray-500 mb-5">ã¾ãŸã¯</p>
                    <label htmlFor="file-upload" className="inline-block bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 px-8 rounded-full cursor-pointer
                      shadow-lg hover:from-blue-600 hover:to-blue-700 transition duration-300 transform hover:-translate-y-1 hover:shadow-xl">
                      ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                    </label>
                    <input
                      id="file-upload"
                      type="file"
                      accept="image/*"
                      onChange={(e) => handleImageChange(e.target.files[0])}
                      className="hidden"
                    />
                  </div>


                  {imagePreviewUrl && (
                    <div className="mb-8 flex justify-center">
                      <img
                        src={imagePreviewUrl}
                        alt="å†·è”µåº«ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼"
                        className="max-w-full h-auto rounded-2xl shadow-xl border-4 border-blue-100"
                        style={{ maxHeight: '350px' }}
                      />
                    </div>
                  )}

                  <button
                    onClick={analyzeImage}
                    disabled={loading || !selectedImage}
                    className="w-full bg-gradient-to-r from-teal-500 to-teal-600 text-white font-bold py-4 px-8 rounded-full
                      hover:from-teal-600 hover:to-teal-700 transition duration-300 ease-in-out
                      shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center text-xl transform hover:-translate-y-1"
                  >
                    {loading ? (
                      <svg className="animate-spin h-6 w-6 mr-3 text-white" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                    ) : (
                      'AIã§é£Ÿæã‚’è§£æ'
                    )}
                  </button>
                </div>

                {error && (
                  <div className="bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-xl relative max-w-2xl w-full mb-10 shadow-md animate-bounce-in" role="alert">
                    <strong className="font-bold">ã‚¨ãƒ©ãƒ¼: </strong>
                    <span className="block sm:inline">{error}</span>
                  </div>
                )}

                {ingredients.length > 0 && (
                  <div ref={ingredientsSectionRef} className="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full mb-10 transform transition-all duration-300 hover:scale-[1.01] hover:shadow-3xl border border-gray-100">
                    <h2 className="text-3xl font-bold text-gray-700 mb-6 border-b-2 border-blue-200 pb-4 text-center">
                      2. è§£æã•ã‚ŒãŸé£Ÿæã¨é¸æŠ
                    </h2>
                    <p className="text-gray-600 mb-6 text-lg text-center">
                      ãƒ¬ã‚·ãƒ”ææ¡ˆã«ä½¿ã‚ãªã„é£Ÿæã¯ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¦ãã ã•ã„ã€‚
                    </p>
                    <ul className="text-gray-800 text-xl space-y-3 mb-8">
                      {ingredients.map((item, index) => (
                        <li key={index} className="flex items-center bg-gray-50 p-3 rounded-lg shadow-sm hover:bg-gray-100 transition duration-200">
                          <input
                            type="checkbox"
                            checked={item.selected}
                            onChange={() => handleIngredientToggle(index)}
                            className="form-checkbox h-6 w-6 text-blue-600 rounded-md mr-4 cursor-pointer focus:ring-blue-500"
                          />
                          <label className="cursor-pointer font-medium">{item.name}</label>
                        </li>
                      ))}
                    </ul>
                    <button
                      onClick={generateRecipes}
                      disabled={loading || ingredients.filter(item => item.selected).length === 0}
                      className="w-full bg-gradient-to-r from-green-500 to-green-600 text-white font-bold py-4 px-8 rounded-full
                        hover:from-green-600 hover:to-green-700 transition duration-300 ease-in-out
                        shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center text-xl transform hover:-translate-y-1"
                  >
                    {loading ? (
                      <svg className="animate-spin h-6 w-6 mr-3 text-white" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                    ) : (
                      'çŒ®ç«‹ã‚’ææ¡ˆ'
                    )}
                  </button>
                </div>
                )}

                {recipes && (
                  <div ref={recipesSectionRef} className="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full mb-10 transform transition-all duration-300 hover:scale-[1.01] hover:shadow-3xl border border-gray-100">
                    <h2 className="text-3xl font-bold text-gray-700 mb-6 border-b-2 border-blue-200 pb-4 text-center">
                      3. ææ¡ˆã•ã‚ŒãŸçŒ®ç«‹
                    </h2>
                    <div className="prose max-w-none text-gray-800 leading-relaxed text-lg">
                      <p dangerouslySetInnerHTML={{ __html: recipes.replace(/\n/g, '<br />') }}></p>
                    </div>

                    {/* AIãƒãƒ£ãƒƒãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
                    {isChatActive && (
                      <div className="mt-8 pt-6 border-t-2 border-gray-200">
                        <h3 className="text-2xl font-bold text-gray-700 mb-4 text-center">
                          AIã¨ä¼šè©±ã™ã‚‹
                        </h3>
                        <div ref={chatHistoryRef} className="bg-gray-50 p-4 rounded-xl h-64 overflow-y-auto mb-4 border border-gray-200 shadow-inner">
                          {chatHistory.map((msg, index) => (
                            <div key={index} className={`mb-3 p-3 rounded-lg max-w-[85%] ${msg.role === 'user' ? 'bg-blue-100 ml-auto text-right' : 'bg-green-100 mr-auto text-left'}`}>
                              <p className="font-semibold text-sm mb-1">{msg.role === 'user' ? 'ã‚ãªãŸ' : 'AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ'}</p>
                              <p className="text-gray-800 text-base">{msg.text}</p>
                            </div>
                          ))}
                          {loading && (
                            <div className="flex justify-center items-center p-3">
                              <svg className="animate-spin h-6 w-6 text-blue-500" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                              </svg>
                            </div>
                          )}
                        </div>
                        <div className="flex gap-2">
                          <textarea
                            className="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent resize-none"
                            rows="3"
                            placeholder="çŒ®ç«‹ã«ã¤ã„ã¦è³ªå•ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã“ã®çŒ®ç«‹ã«åˆã†é£²ã¿ç‰©ã¯ï¼Ÿã€åˆ¥ã®çŒ®ç«‹ã‚’ææ¡ˆã—ã¦ï¼‰"
                            value={currentChatMessage}
                            onChange={(e) => setCurrentChatMessage(e.target.value)}
                            onKeyPress={(e) => {
                              if (e.key === 'Enter' && !e.shiftKey) {
                                e.preventDefault();
                                sendChatMessage();
                              }
                            }}
                            disabled={loading}
                          ></textarea>
                          <button
                            onClick={sendChatMessage}
                            disabled={loading || !currentChatMessage.trim()}
                            className="bg-blue-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0"
                          >
                            é€ä¿¡
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>

              {/* AIåˆ†æã®æ³¨æ„ç‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
              <div className="bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 p-6 rounded-lg shadow-md max-w-2xl w-full mt-10 mb-8 mx-auto">
                <div className="flex items-center mb-2">
                  <svg className="h-6 w-6 text-yellow-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                  <h3 className="text-xl font-bold text-center">AIåˆ†æã«é–¢ã™ã‚‹æ³¨æ„ç‚¹</h3>
                </div>
                <p className="text-gray-700 text-base">
                  AIã¯ç”»åƒã‹ã‚‰é£Ÿæã‚’è­˜åˆ¥ã—ã¾ã™ãŒã€å®Œç’§ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚èª¤èªè­˜ã‚„èªè­˜æ¼ã‚ŒãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ã€‚<br />
                  ææ¡ˆã•ã‚Œã‚‹çŒ®ç«‹ã¯ã€AIãŒå­¦ç¿’ã—ãŸæƒ…å ±ã«åŸºã¥ã„ã¦å®Ÿç”¨çš„ãªã‚‚ã®ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ãŒã€**å¿…ãšã—ã‚‚èª¿ç†å¯èƒ½ã§ã‚ã£ãŸã‚Šã€ãŠå¥½ã¿ã®å‘³ä»˜ã‘ã§ã‚ã‚‹ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚**<br />
                  **èª¿ç†å‰ã«ã”è‡ªèº«ã§ãƒ¬ã‚·ãƒ”ã®å†…å®¹ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦Webæ¤œç´¢ãªã©ã§è©³ç´°ãªæƒ…å ±ã‚„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚**æœ€çµ‚çš„ãªåˆ¤æ–­ã¯ã”è‡ªèº«ã§è¡Œã£ã¦ãã ã•ã„ã€‚
                </p>
              </div>
            </>
          );
        };

        // Reactã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ«ãƒ¼ãƒˆè¦ç´ ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
